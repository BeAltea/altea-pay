# Altea Pay - System Diagrams

> Text-based architectural and flow diagrams for the Altea Pay platform.

---

## Table of Contents

1. [System Architecture](#1-system-architecture)
2. [Payment Flow](#2-payment-flow)
3. [Data Flow Diagrams](#3-data-flow-diagrams)
4. [Authentication Flow](#4-authentication-flow)
5. [Integration Architecture](#5-integration-architecture)

---

## 1. System Architecture

### 1.1 High-Level Architecture

\`\`\`
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION LAYER                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │   Super Admin   │  │  Company Admin  │  │      User (Debtor)          │  │
│  │   /super-admin  │  │   /dashboard    │  │     /user-dashboard         │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────┬───────────────┘  │
│           │                    │                         │                   │
│           └────────────────────┼─────────────────────────┘                   │
│                                │                                             │
│                    ┌───────────▼───────────┐                                 │
│                    │   Next.js App Router  │                                 │
│                    │   (Server Components) │                                 │
│                    └───────────┬───────────┘                                 │
└────────────────────────────────┼─────────────────────────────────────────────┘
                                 │
┌────────────────────���───────────┼─────────────────────────────────────────────┐
│                          API LAYER                                           │
│  ┌─────────────────┐  ┌───────▼───────┐  ┌─────────────────────────────────┐│
│  │  Server Actions │  │  API Routes   │  │         Webhooks                ││
│  │  app/actions/*  │  │  app/api/*    │  │  /api/webhooks/asaas           ││
│  └────────┬────────┘  └───────┬───────┘  └─────────────┬───────────────────┘│
│           │                   │                        │                     │
│           └───────────────────┼────────────────────────┘                     │
│                               │                                              │
└───────────────────────────────┼──────────────────────────────────────────────┘
                                │
┌───────────────────────────────┼──────────────────────────────────────────────┐
│                     BUSINESS LOGIC LAYER                                     │
│  ┌──────────────────┐  ┌──────▼──────┐  ┌──────────────────┐                │
│  │ Credit Analysis  │  │ Collection  │  │   Propensity     │                │
│  │     Engine       │  │   Engine    │  │     Engine       │                │
│  └──────────────────┘  └─────────────┘  └──────────────────┘                │
│  ┌──────────────────┐  ┌─────────────┐  ┌──────────────────┐                │
│  │  Classification  │  │   Payment   │  │   Notification   │                │
│  │     Engine       │  │  Processor  │  │     Service      │                │
│  └──────────────────┘  └─────────────┘  └──────────────────┘                │
└───────────────────────────────┼──────────────────────────────────────────────┘
                                │
┌───────────────────────────────┼──────────────────────────────────────────────┐
│                      DATA ACCESS LAYER                                       │
│                    ┌──────────▼──────────┐                                   │
│                    │   Supabase Client   │                                   │
│                    │  (Browser/Server/   │                                   │
│                    │      Admin)         │                                   │
│                    └──────────┬──────────┘                                   │
└───────────────────────────────┼──────────────────────────────────────────────┘
                                │
┌───────────────────────────────┼──────────────────────────────────────────────┐
│                       DATABASE LAYER                                         │
│                    ┌──────────▼──────────┐                                   │
│                    │      Supabase       │                                   │
│                    │     PostgreSQL      │                                   │
│                    │    + Row Level      │                                   │
│                    │     Security        │                                   │
│                    └────────────────────┘                                    │
└──────────────────────────────────────────────────────────────────────────────┘
\`\`\`

### 1.2 Multi-Tenant Architecture

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                           PLATFORM LEVEL                                     │
│                                                                              │
│    ┌──────────────────────────────────────────────────────────────────────┐  │
│    │                         Super Admin                                   │  │
│    │                   (Platform Management)                               │  │
│    └──────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│         ┌──────────────────────────┼──────────────────────────┐              │
│         │                          │                          │              │
│         ▼                          ▼                          ▼              │
│    ┌─────────┐               ┌─────────┐               ┌─────────┐           │
│    │Company A│               │Company B│               │Company C│           │
│    └────┬────┘               └────┬────┘               └────┬────┘           │
│         │                         │                         │                │
│    ┌────┴────────────┐       ┌────┴────────────┐       ┌────┴────────────┐   │
│    │                 │       │                 │       │                 │   │
│    ▼                 ▼       ▼                 ▼       ▼                 ▼   │
│ ┌──────┐         ┌──────┐ ┌──────┐         ┌──────┐ ┌──────┐         ┌──────┐│
│ │Admins│         │Debts │ │Admins│         │Debts │ │Admins│         │Debts ││
│ └──────┘         └──────┘ └──────┘         └──────┘ └──────┘         └──────┘│
│                                                                              │
│    ═══════════════════════════════════════════════════════════════════════   │
│                     Row Level Security (company_id)                          │
│    ═══════════════════════════════════════════════════════════════════════   │
│                                                                              │
│                    ┌────────────────────────────────┐                        │
│                    │     Shared PostgreSQL DB       │                        │
│                    │    (Data Isolated by RLS)      │                        │
│                    └────────────────────────────────┘                        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
\`\`\`

### 1.3 Component Architecture

\`\`\`
┌─────────────────────────────────────────────────────────────────────────────┐
│                              NEXT.JS APPLICATION                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   app/                                                                      │
│   ├── auth/               ─────►  Authentication Pages                      │
│   │   ├── login/                  (Login, Register, Reset)                  │
│   │   ├── register/                                                         │
│   │   └── reset-password/                                                   │
│   │                                                                         │
│   ├── dashboard/          ─────►  Company Admin Interface                   │
│   │   ├── customers/              (Customer, Debt, Collection Mgmt)         │
│   │   ├── debts/                                                            │
│   │   ├── collection/                                                       │
│   │   └── settings/                                                         │
│   │                                                                         │
│   ├── super-admin/        ─────►  Platform Admin Interface                  │
│   │   ├── companies/              (Company, Integration Mgmt)               │
│   │   ├── integrations/                                                     │
│   │   └── analytics/                                                        │
│   │                                                                         │
│   ├── user-dashboard/     ─────►  Debtor Portal                             │
│   │   ├── debts/                  (View Debts, Make Payments)               │
│   │   └── payments/                                                         │
│   │                                                                         │
│   └── api/                ─────►  API Endpoints                             │
│       ├── webhooks/               (Webhooks, Cron Jobs, REST)               │
│       ├── cron/                                                             │
│       └── [domain]/                                                         │
│                                                                             │
│   lib/                    ─────►  Business Logic                            │
│   ├── collection-engine.ts        (Engines, Utilities)                      │
│   ├── credit-analysis-engine.ts                                             │
│   ├── propensity-engine.ts                                                  │
│   └── classification-engine.ts                                              │
│                                                                             │
│   services/               ─────►  External Integrations                     │
│   ├── assertivaService.ts         (API Clients)                             │
│   └── erpConnectors/                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
\`\`\`

---

## 2. Payment Flow

### 2.1 Payment Creation Sequence

\`\`\`
┌────────┐     ┌──────────┐     ┌───────────┐     ┌───────┐     ┌────────────┐
│ Debtor │     │  Altea   │     │   ASAAS   │     │  DB   │     │Notification│
│        │     │   Pay    │     │  Gateway  │     │       │     │  Service   │
└───┬────┘     └────┬─────┘     └─────┬─────┘     └───┬───┘     └─────┬──────┘
    │               │                 │               │               │
    │ 1. Request    │                 │               │               │
    │    Payment    │                 │               │               │
    │──────────────►│                 │               │               │
    │               │                 │               │               │
    │               │ 2. Create/Get   │               │               │
    │               │    Customer     │               │               │
    │               │────────────────►│               │               │
    │               │                 │               │               │
    │               │◄────────────────│               │               │
    │               │ Customer ID     │               │               │
    │               │                 │               │               │
    │               │ 3. Create       │               │               │
    │               │    Payment      │               │               │
    │               │────────────────►│               │               │
    │               │                 │               │               │
    │               │◄────────────────│               │               │
    │               │ Payment Link    │               │               │
    │               │ (PIX/Boleto/CC) │               │               │
    │               │                 │               │               │
    │               │ 4. Store Payment│               │               │
    │               │─────────────────┼──────────────►│               │
    │               │                 │               │               │
    │◄──────────────│                 │               │               │
    │ Payment Link  │                 │               │               │
    │               │                 │               │               │
    │               │ 5. Send         │               │               │
    │               │    Notification │               │               │
    │               │─────────────────┼───────────────┼──────────────►│
    │               │                 │               │               │
    │◄──────────────┼─────────────────┼───────────────┼───────────────│
    │ Email/SMS     │                 │               │               │
    │ with Link     │                 │               │               │
    │               │                 │               │               │
\`\`\`

### 2.2 Payment Confirmation (Webhook) Flow

\`\`\`
┌───────┐     ┌───────────────┐     ┌──────────┐     ┌───────┐     ┌────────────┐
│ ASAAS │     │   Webhook     │     │  Altea   │     │  DB   │     │Notification│
│       │     │   Handler     │     │   Pay    │     │       │     │  Service   │
└───┬───┘     └───────┬───────┘     └────┬─────┘     └───┬───┘     └─────┬──────┘
    │                 │                  │               │               │
    │ 1. Payment      │                  │               │               │
    │    Event        │                  │               │               │
    │────────────────►│                  │               │               │
    │                 │                  │               │               │
    │                 │ 2. Parse Event   │               │               │
    │                 │    Type          │               │               │
    │                 │──────────────────►               │               │
    │                 │                  │               │               │
    │                 │ 3. Find Debt     │               │               │
    │                 │    (4 strategies)│               │               │
    │                 │──────────────────┼──────────────►│               │
    │                 │                  │               │               │
    │                 │◄─────────────────┼───────────────│               │
    │                 │                  │               │               │
    │                 │ 4. Update Status │               │               │
    │                 │──────────────────┼──────────────►│               │
    │                 │                  │               │               │
    │                 │ 5. Log Event     │               │               │
    │                 │──────────────────┼──────────────►│               │
    │                 │                  │               │               │
    │                 │ 6. Send          │               │               │
    │                 │    Confirmation  │               │               │
    │                 │──────────────────┼───────────────┼──────────────►│
    │                 │                  │               │               │
    │◄────────────────│                  │               │               │
    │ 200 OK          │                  │               │               │
    │                 │                  │               │               │
\`\`\`

### 2.3 Payment Methods Decision Tree

\`\`\`
                          ┌─────────────────────┐
                          │   Payment Request   │
                          └──────────┬──────────┘
                                     │
                          ┌──────────▼──────────┐
                          │  Select Payment     │
                          │      Method         │
                          └──────────┬──────────┘
                                     │
          ┌──────────────────────────┼──────────────────────────┐
          │                          │                          │
          ▼                          ▼                          ▼
   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐
   │     PIX     │           │   BOLETO    │           │ CREDIT CARD │
   └──────┬──────┘           └──────┬──────┘           └──────┬──────┘
          │                         │                          │
          ▼                         ▼                          ▼
   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐
   │ Generate    │           │ Generate    │           │ Tokenize    │
   │ QR Code     │           │ Barcode     │           │ Card Data   │
   └──────┬──────┘           └──────┬──────┘           └──────┬──────┘
          │                         │                          │
          ▼                         ▼                          ▼
   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐
   │ Instant     │           │ 1-3 Days    │           │ Instant     │
   │ Confirmation│           │ Processing  │           │ Auth        │
   └──────┬──────┘           └──────┬──────┘           └──────┬──────┘
          │                         │                          │
          └──────────────────────────┼──────────────────────────┘
                                     │
                          ┌──────────▼──────────┐
                          │  Webhook Callback   │
                          │  (Status Update)    │
                          └──────────┬──────────┘
                                     │
                          ┌──────────▼──────────┐
                          │   Update Debt       │
                          │   Status: PAID      │
                          └─────────────────────┘
\`\`\`

---

## 3. Data Flow Diagrams

### 3.1 ERP Synchronization Flow

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                           ERP SYNC FLOW                                      │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌───────────┐                                         ┌───────────────────┐
    │  Vercel   │                                         │   External ERP    │
    │  Cron     │                                         │   (TOTVS/Sankhya) │
    │  0 */6 * *│                                         └─────────┬─────────┘
    └─────┬─────┘                                                   │
          │                                                         │
          │ 1. Trigger                                              │
          ▼                                                         │
    ┌─────────────────┐                                             │
    │ /api/cron/      │                                             │
    │ sync-erp        │                                             │
    └────────┬────────┘                                             │
             │                                                      │
             │ 2. Auth Check                                        │
             ▼                                                      │
    ┌─────────────────┐                                             │
    │ CRON_SECRET     │──── Invalid ────►  401 Unauthorized         │
    │ Validation      │                                             │
    └────────┬────────┘                                             │
             │ Valid                                                │
             ▼                                                      │
    ┌─────────────────┐                                             │
    │ Get Companies   │                                             │
    │ with ERP Config │                                             │
    └────────┬────────┘                                             │
             │                                                      │
             │ 3. For Each Company                                  │
             ▼                                                      │
    ┌─────────────────┐         4. API Call          ┌──────────────┴─────────┐
    │ ERP Connector   │─────────────────────────────►│   Fetch Receivables    │
    │ (TOTVS/Sankhya/ │                              │   & Customer Data      │
    │  Omie)          │◄─────────────────────────────│                        │
    └────────┬────────┘         Raw Data             └────────────────────────┘
             │
             │ 5. Transform
             ▼
    ┌─────────────────┐
    │ Data Transform  │
    │ - Normalize     │
    │ - Validate      │
    │ - Map Fields    │
    └────────┬────────┘
             │
             │ 6. Upsert
             ▼
    ┌─────────────────┐
    │ Supabase DB     │
    │ - customers     │
    │ - debts         │
    │ - erp_sync_logs │
    └─────────────────┘
\`\`\`

### 3.2 Collection Engine Flow

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                        COLLECTION ENGINE FLOW                                │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │ Trigger Sources │
    ├─────────────────┤
    │ • Cron Job      │
    │ • New Debt      │
    │ • Manual        │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────────┐
    │         Get Eligible Debts              │
    │   status = 'pending' | 'overdue'        │
    │   days_overdue matches rule triggers    │
    └────────────────┬────────────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────────────┐
    │      For Each Debt: Get Recovery Score  │
    │         (from credit_profiles)          │
    └────────────────┬────────────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────────────┐
    │          Check Collection Rules         │
    │    (company's custom rules in VMAX)     │
    └────────────────┬────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │ Has Matching Rule?    │
         └───────────┬───────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ┌────▼────┐            ┌─────▼─────┐
    │   YES   │            │    NO     │
    │ Execute │            │  Apply    │
    │  Rule   │            │  Default  │
    └────┬────┘            └─────┬─────┘
         │                       │
         │                       ▼
         │              ┌─────────────────────┐
         │              │  Recovery Score     │
         │              │     >= 294?         │
         │              └─────────┬───────────┘
         │                        │
         │              ┌─────────┴─────────┐
         │              │                   │
         │         ┌────▼────┐         ┌────▼────┐
         │         │   YES   │         │   NO    │
         │         │  AUTO   │         │ MANUAL  │
         │         │DISPATCH │         │  TASK   │
         │         └────┬────┘         └────┬────┘
         │              │                   │
         ▼              ▼                   ▼
    ┌─────────────────────────────────────────┐
    │            Execute Action               │
    ├─────────────────────────────────────────┤
    │  • Send Email   (Resend)                │
    │  • Send SMS     (Twilio)                │
    │  • Send WhatsApp (Twilio)               │
    │  • Create Manual Task                   │
    └────────────────┬────────────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────────────┐
    │            Log Execution                │
    │  collection_rule_executions table       │
    └─────────────────────────────────────────┘
\`\`\`

### 3.3 Credit Analysis Flow

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                       CREDIT ANALYSIS FLOW                                   │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │ Analysis        │
    │ Request (CPF)   │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────────┐
    │     Check Cache (credit_profiles)       │
    │        analysis_date < 30 days?         │
    └────────────────┬────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ┌────▼────┐            ┌─────▼─────┐
    │ CACHED  │            │ NOT FOUND │
    │ Return  │            │ or STALE  │
    │ Result  │            └─────┬─────┘
    └─────────┘                  │
                                 ▼
                    ┌─────────────────────────┐
                    │   Assertiva API Call    │
                    │   (OAuth2 + Retry)      │
                    └────────────┬────────────┘
                                 │
                                 ▼
                    ┌─────────────────────────┐
                    │   Get Score & Data      │
                    │   • Score (0-1000)      │
                    │   • Pendências          │
                    │   • Protestos           │
                    │   • Processos           │
                    └────────────┬────────────┘
                                 │
                                 ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                    CREDIT ANALYSIS ENGINE                               │
    │  ┌────────────────────────────────────────────────────────────────────┐ │
    │  │              Apply 7 Business Rules (R1-R7)                        │ │
    │  ├────────────────────────────────────────────────────────────────────┤ │
    │  │  R1: Classificar Risco (Score)                                     │ │
    │  │      └─ Score >= 400: BAIXO  |  >= 300: MÉDIO  |  < 300: ALTO      │ │
    │  │                                                                    │ │
    │  │  R2: Negativação Check                                             │ │
    │  │      └─ Has SPC/Serasa: REJECT                                     │ │
    │  │                                                                    │ │
    │  │  R3: Protesto Check                                                │ │
    │  │      └─ Recent protests: REJECT                                    │ │
    │  │                                                                    │ │
    │  │  R4: Judicial Process Check                                        │ │
    │  │      └─ Active processes: REJECT                                   │ │
    │  │                                                                    │ │
    │  │  R5: Payment History                                               │ │
    │  │      └─ Good history bonus                                         │ │
    │  │                                                                    │ │
    │  │  R6: Engagement Level                                              │ │
    │  │      └─ High engagement bonus                                      │ │
    │  │                                                                    │ │
    │  │  R7: Final Decision                                                │ │
    │  │      └─ Combine all factors                                        │ │
    │  └──────────────────────────────────────────────────────��─────────────┘ │
    └────────────────────────────────┬────────────────────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────┐
                    │         Decision Output         │
                    ├─────────────────────────────────┤
                    │  • APPROVED: Auto collection    │
                    │  • MANUAL: Human review         │
                    │  • REJECTED: No collection      │
                    └─────────────────────────────────┘
\`\`\`

---

## 4. Authentication Flow

### 4.1 Login Flow

\`\`\`
┌────────┐     ┌──────────┐     ┌──────────┐     ┌───────────┐     ┌──────────┐
│  User  │     │  Login   │     │ Supabase │     │Middleware │     │Dashboard │
│        │     │  Page    │     │   Auth   │     │           │     │          │
└───┬────┘     └────┬─────┘     └────┬─────┘     └─────┬─────┘     └────┬─────┘
    │               │                │                 │                │
    │ 1. Visit      │                │                 │                │
    │    /auth/login│                │                 │                │
    │──────────────►│                │                 │                │
    │               │                │                 │                │
    │ 2. Enter      │                │                 │                │
    │    Credentials│                │                 │                │
    │──────────────►│                │                 │                │
    │               │                │                 │                │
    │               │ 3. signInWith  │                 │                │
    │               │    Password()  │                 │                │
    │               │───────────────►│                 │                │
    │               │                │                 │                │
    │               │◄───────────────│                 │                │
    │               │  Session +     │                 │                │
    │               │  User Data     │                 │                │
    │               │                │                 │                │
    │               │ 4. Set Cookie  │                 │                │
    │               │───────────────►│                 │                │
    │               │                │                 │                │
    │               │ 5. Redirect    │                 │                │
    │◄──────────────│    to /        │                 │                │
    │               │                │                 │                │
    │ 6. Request /  │                │                 │                │
    │──────────────►│                │                 │                │
    │               │                │                 │                │
    │               │─────────────────────────────────►│                │
    │               │                │                 │                │
    │               │                │   7. Validate   │                │
    │               │                │      Session    │                │
    │               │                │◄────────────────│                │
    │               │                │                 │                │
    │               │                │   8. Get Profile│                │
    │               │                │      & Role     │                │
    │               │                │◄────────────────│                │
    │               │                │                 │                │
    │               │                │   9. Route by   │                │
    │               │                │      Role       │                │
    │               │                │────────────────►│                │
    │               │                │                 │                │
    │◄─────────────────────────────────────────────────┼────────────────│
    │ Redirect to role-specific dashboard              │                │
    │ • super_admin → /super-admin                     │                │
    │ • admin → /dashboard                             │                │
    │ • user → /user-dashboard                         │                │
    │               │                │                 │                │
\`\`\`

### 4.2 Session Validation & Role Routing

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                        MIDDLEWARE FLOW                                       │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │ Incoming        │
    │ Request         │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────────┐
    │      Is Public Path?                    │
    │  • /                                    │
    │  • /auth/*                              │
    │  • /api/webhooks/*                      │
    │  • /api/public/*                        │
    └────────────────┬────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ┌────▼────┐            ┌─────▼─────┐
    │   YES   │            │    NO     │
    │ Allow   │            │ Continue  │
    │ Pass    │            │ Check     │
    └─────────┘            └─────┬─────┘
                                 │
                                 ▼
                    ┌─────────────────────────┐
                    │   Get Supabase Session  │
                    │   from Cookies          │
                    └──────────��─┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │    Session Valid?       │
                    └────────────┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
               ┌────▼────┐              ┌─────▼─────┐
               │   NO    │              │    YES    │
               │Redirect │              │ Get User  │
               │to Login │              │ Profile   │
               └─────────┘              └─────┬─────┘
                                              │
                                              ▼
                    ┌─────────────────────────────────────────────────────┐
                    │              ROLE-BASED ROUTING                     │
                    ├─────────────────────────────────────────────────────┤
                    │                                                     │
                    │  Profile.role     │  Allowed Paths    │  Redirect   │
                    │  ─────────────────┼───────────────────┼───────────  │
                    │  super_admin      │  /super-admin/*   │  /super-    │
                    │                   │  /dashboard/*     │   admin     │
                    │                   │  /user-dashboard/*│             │
                    │  ─────────────────┼───────────────────┼───────────  │
                    │  admin            │  /dashboard/*     │  /dashboard │
                    │  ─────────────────┼───────────────────┼───────────  │
                    │  user             │  /user-dashboard/*│  /user-     │
                    │                   │                   │   dashboard │
                    │                                                     │
                    └─────────────────────────────────────────────────────┘
\`\`\`

### 4.3 Session Refresh Flow

\`\`\`
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                    SESSION REFRESH FLOW                                 │
    └─────────────────────────────────────────────────────────────────────────┘

         Browser                    Middleware                  Supabase
            │                           │                          │
            │  1. Request with          │                          │
            │     expired JWT           │                          │
            │──────────────────────────►│                          │
            │                           │                          │
            │                           │  2. Check refresh        │
            │                           │     token in cookie      │
            │                           │─────────────────────────►│
            │                           │                          │
            │                           │◄─────────────────────────│
            │                           │  3. New access token     │
            │                           │                          │
            │◄──────────────────────────│                          │
            │  4. Set-Cookie:           │                          │
            │     new access token      │                          │
            │                           │                          │
            │  5. Continue request      │                          │
            │     with new session      │                          │
            │──────────────────────────►│                          │
            │                           │                          │
\`\`\`

---

## 5. Integration Architecture

### 5.1 External Services Overview

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                        ALTEA PAY - INTEGRATION MAP                           │
└──────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────────────┐
                              │                   │
                              │    ALTEA PAY      │
                              │    APPLICATION    │
                              │                   │
                              └─────────┬─────────┘
                                        │
        ┌───────────────────────────────┼───────────────────────────────┐
        │                               │                               │
        ▼                               ▼                               ▼
┌───────────────┐             ┌───────────────────┐           ┌───────────────┐
│   PAYMENTS    │             │  COMMUNICATION    │           │   ANALYTICS   │
├───────────────┤             ├───────────────────┤           ├───────────────┤
│               │             │                   │           │               │
│  ┌─────────┐  │             │  ┌─────────────┐  │           │  ┌─────────┐  │
│  │  ASAAS  │  │             │  │   RESEND    │  │           │  │ASSERTIVA│  │
│  │ Gateway │  │             │  │   (Email)   │  │           │  │ (Credit)│  │
│  └─────────┘  │             │  └─────────────┘  │           │  └─────────┘  │
│               │             │                   │           │               │
│  • PIX        │             │  • Transactional  │           │  • Score      │
│  • Boleto     │             │  • Collection     │           │  • Pendências │
│  • Credit Card│             │  • Confirmation   │           │  • Protestos  │
│  • Webhooks   │             │                   │           │  • Processos  │
│               │             │  ┌─────────────┐  │           │               │
│               │             │  │   TWILIO    │  │           │               │
│               │             │  │  (SMS/WA)   │  │           │               │
│               │             │  └─────────────┘  │           │               │
│               │             │                   │           │               │
│               │             │  • SMS Alerts     │           │               │
│               │             │  • WhatsApp       │           │               │
│               │             │  • Collection     │           │               │
│               │             │                   │           │               │
└───────────────┘             └───────────────────┘           └───────────────┘

        │                               │                               │
        └───────────────────────────────┼───────────────────────────────┘
                                        │
                                        ▼
                              ┌───────────────────┐
                              │   ERP SYSTEMS     │
                              ├───────────────────┤
                              │                   │
                              │  ┌─────────────┐  │
                              │  │   TOTVS     │  │
                              │  └─────────────┘  │
                              │                   │
                              │  ┌─────────────┐  │
                              │  │  SANKHYA    │  │
                              │  └─────────────┘  │
                              │                   │
                              │  ┌─────────────┐  │
                              │  │    OMIE     │  │
                              │  └─────────────┘  │
                              │                   │
                              │  • Customer Sync  │
                              │  • Debt Import    │
                              │  • Payment Export │
                              │                   │
                              └───────────────────┘
\`\`\`

### 5.2 ASAAS Integration Detail

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                        ASAAS INTEGRATION ARCHITECTURE                        │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                          ALTEA PAY                                      │
    │  ┌─────────────────────────────────────────────────────────────────┐   │
    │  │                    lib/asaas.ts                                  │   │
    │  │                    lib/asaas-integration.ts                      │   │
    │  ├─────────────────────────────────────────────────────────────────┤   │
    │  │                                                                  │   │
    │  │   AsaasClient                                                    │   │
    │  │   ├── createCustomer(data)                                       │   │
    │  │   ├── getCustomerByCpfCnpj(cpf)                                  │   │
    │  │   ├── createPayment(data)                                        │   │
    │  │   ├── getPayment(id)                                             │   │
    │  │   ├── generatePixQrCode(paymentId)                               │   │
    │  │   └── getBoletoUrl(paymentId)                                    │   │
    │  │                                                                  │   │
    │  └─────────────────────────────────────────────────────────────────┘   │
    │                                    │                                    │
    │                                    │ HTTPS                              │
    │                                    │ API Key Auth                       │
    │                                    ▼                                    │
    └─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │
    ┌────────────────────────────────────▼────────────────────────────────────┐
    │                          ASAAS API                                      │
    │                   https://api.asaas.com/v3                              │
    │              (sandbox: https://sandbox.asaas.com/api/v3)                │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   Endpoints Used:                                                       │
    │   ├── POST /customers                    Create customer                │
    │   ├── GET  /customers?cpfCnpj=xxx        Find customer by CPF           │
    │   ├── POST /payments                     Create payment                 │
    │   ├── GET  /payments/{id}                Get payment details            │
    │   ├── GET  /payments/{id}/pixQrCode      Get PIX QR code                │
    │   └── GET  /payments/{id}/identificationField  Get boleto barcode       │
    │                                                                         │
    │   Webhook Events:                                                       │
    │   ├── PAYMENT_CREATED                                                   │
    │   ├── PAYMENT_CONFIRMED                                                 │
    │   ├── PAYMENT_RECEIVED                                                  │
    │   ├── PAYMENT_OVERDUE                                                   │
    │   ├── PAYMENT_REFUNDED                                                  │
    │   └── PAYMENT_DELETED                                                   │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │ Webhook POST
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      app/api/webhooks/asaas/route.ts                    │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   Debt Lookup Strategies (in order):                                    │
    │   1. asaas_payment_id exact match                                       │
    │   2. asaas_payment_id prefix match (for installments)                   │
    │   3. External reference (externalReference field)                       │
    │   4. Customer ID + Amount match                                         │
    │                                                                         │
    │   Status Mapping:                                                       │
    │   PAYMENT_RECEIVED  →  debt.status = 'paid'                             │
    │   PAYMENT_CONFIRMED →  debt.status = 'paid'                             │
    │   PAYMENT_OVERDUE   →  debt.status = 'overdue'                          │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
\`\`\`

### 5.3 Assertiva Credit Analysis Integration

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                     ASSERTIVA INTEGRATION ARCHITECTURE                       │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                          ALTEA PAY                                      │
    │                                                                         │
    │  ┌─────────────────────────────────────────────────────────────────┐   │
    │  │                services/assertivaService.ts                      │   │
    │  ├─────────────────────────────────────────────────────────────────┤   │
    │  │                                                                  │   │
    │  │   Token Management:                                              │   │
    │  │   ├── cachedToken: string | null                                 │   │
    │  │   ├── tokenExpiry: number                                        │   │
    │  │   └── getAccessToken() → OAuth2 token with auto-refresh          │   │
    │  │                                                                  │   │
    │  │   API Methods:                                                   │   │
    │  │   ├── analyzeDetailedWithCache(cpf, companyId)                   │   │
    │  │   │   └── Checks credit_profiles cache first                     │   │
    │  │   │   └── Falls back to API if stale (>30 days)                  │   │
    │  │   │                                                              │   │
    │  │   └── analyzeCredit(cpf)                                         │   │
    │  │       └── Direct API call with retry logic                       │   │
    │  │                                                                  │   │
    │  └─────────────────────────────────────────────────────────────────┘   │
    │                                    │                                    │
    └────────────────────────────────────┼────────────────────────────────────┘
                                         │
                                         │ HTTPS + OAuth2
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                       ASSERTIVA API                                     │
    │              https://api.assertivasolucoes.com.br                       │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   Authentication:                                                       │
    │   POST /oauth/token                                                     │
    │   └── client_id + client_secret → access_token (1h expiry)              │
    │                                                                         │
    │   Credit Analysis:                                                      │
    │   GET /localize/v3/cpf/{cpf}                                            │
    │   └── Returns:                                                          │
    │       ├── score (0-1000)                                                │
    │       ├── pendencias[] (pending debts)                                  │
    │       ├── protestos[] (protests)                                        │
    │       ├── processos[] (legal processes)                                 │
    │       └── situacao (status: regular, irregular)                         │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │ Response
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                    lib/credit-analysis-engine.ts                        │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   Input: Assertiva response data                                        │
    │                                                                         │
    │   Processing:                                                           │
    │   ├── decidirEntradaRegua() → Entry decision                            │
    │   ├── classificarComportamento() → Behavior classification              │
    │   └── 7 Business Rules (R1-R7)                                          │
    │                                                                         │
    │   Output: { decision, risk_level, recommendation }                      │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
\`\`\`

### 5.4 Notification Services Integration

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                    NOTIFICATION SERVICES ARCHITECTURE                        │
└──────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────────────┐
                              │  Collection       │
                              │  Engine           │
                              │  (Trigger)        │
                              └─────────┬─────────┘
                                        │
                                        ▼
                    ┌───────────────────────────────────────┐
                    │      lib/notifications/index.ts       │
                    │                                       │
                    │   sendCollectionNotification(opts)    │
                    │   ├── channel: 'email'|'sms'|'whatsapp'│
                    │   ├── template: string                │
                    │   └── variables: object               │
                    │                                       │
                    └───────────────────┬───────────────────┘
                                        │
                ┌───────────────────────┼───────────────────────┐
                │                       │                       │
                ▼                       ▼                       ▼
    ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
    │       EMAIL       │   │        SMS        │   │     WHATSAPP      │
    ├───────────────────┤   ├───────────────────┤   ├───────────────────┤
    │                   │   │                   │   │                   │
    │  Provider: Resend │   │ Provider: Twilio  │   │ Provider: Twilio  │
    │                   │   │                   │   │                   │
    │  Config:          │   │  Config:          │   │  Config:          │
    │  RESEND_API_KEY   │   │  TWILIO_ACCOUNT   │   │  TWILIO_ACCOUNT   │
    │                   │   │  _SID             │   │  _SID             │
    │  Features:        │   │  TWILIO_AUTH      │   │  TWILIO_AUTH      │
    │  • HTML templates │   │  _TOKEN           │   │  _TOKEN           │
    │  • Tracking       │   │  TWILIO_PHONE     │   │  TWILIO_PHONE     │
    │  • Attachments    │   │  _NUMBER          │   │  _NUMBER          │
    │                   │   │                   │   │                   │
    │  Templates:       │   │  Features:        │   │  Features:        │
    │  • collection     │   │  • Short messages │   │  • Rich messages  │
    │  • payment_conf   │   │  • Delivery       │   │  • Templates      │
    │  • reminder       │   │    status         │   │  • Media support  │
    │                   │   │                   │   │                   │
    └─────────┬─────────┘   └─────────┬─────────┘   └─────────┬─────────┘
              │                       │                       │
              │                       │                       │
              ▼                       ▼                       ▼
    ┌───────────────────────────────────────────────────────────────────────┐
    │                    EXTERNAL SERVICE APIs                              │
    ├───────────────────────────────────────────────────────────────────────┤
    │                                                                       │
    │   Resend API                    Twilio API                            │
    │   https://api.resend.com        https://api.twilio.com                │
    │                                                                       │
    │   POST /emails                  POST /Messages.json                   │
    │   ├── from: noreply@...         ├── To: +55...                        │
    │   ├── to: customer@...          ├── From: TWILIO_PHONE                │
    │   ├── subject: ...              ├── Body: message                     │
    │   └── html: template            └── (WhatsApp: whatsapp:+55...)       │
    │                                                                       │
    └───────────────────────────���───────────────────────────────────────────┘
\`\`\`

### 5.5 ERP Connector Architecture

\`\`\`
┌──────────────────────────────────────────────────────────────────────────────┐
│                       ERP CONNECTOR ARCHITECTURE                             │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        CONNECTOR PATTERN                                │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   interface ERPConnector {                                              │
    │     connect(): Promise<void>                                            │
    │     fetchCustomers(): Promise<Customer[]>                               │
    │     fetchReceivables(): Promise<Receivable[]>                           │
    │     syncPayment(payment: Payment): Promise<void>                        │
    │   }                                                                     │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │ Implements
                                         │
         ┌───────────────────────────────┼───────────────────────────────┐
         │                               │                               │
         ▼                               ▼                               ▼
    ┌─────────────┐               ┌─────────────┐               ┌─────────────┐
    │   TOTVS     │               │  SANKHYA    │               │    OMIE     │
    │  Connector  │               │  Connector  │               │  Connector  │
    ├─────────────┤               ├─────────────┤               ├─────────────┤
    │             │               │             │               │             │
    │ Auth: OAuth │               │ Auth: Token │               │ Auth: AppKey│
    │             │               │             │               │  + AppSecret│
    │ Endpoints:  │               │ Endpoints:  │               │             │
    │ REST API    │               │ SOAP/REST   │               │ Endpoints:  │
    │             │               │             │               │ REST API    │
    │ Data:       │               │ Data:       │               │             │
    │ • ZCLIENTE  │               │ • Parceiro  │               │ Data:       │
    │ • SE1 (Recv)│               │ • Financeiro│               │ • clientes  │
    │             │               │             │               │ • contas_rec│
    ��             │               │             │               │             │
    └──────┬──────┘               └──────┬──────┘               └──────┬──────┘
           │                             │                             │
           │                             │                             │
           └─────────────────────────────┼─────────────────────────────┘
                                         │
                                         │ Normalized Data
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         DATA TRANSFORMER                                │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   ERP-specific data  ──────────►  Altea Pay schema                      │
    │                                                                         │
    │   • Customer mapping                                                    │
    │     ├── name, email, phone                                              │
    │     └── document (CPF/CNPJ)                                             │
    │                                                                         │
    │   • Receivable mapping                                                  │
    │     ├── amount, due_date                                                │
    │     ├── document_number                                                 │
    │     └── installment_number                                              │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │ Upsert
                                         ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           SUPABASE                                      │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │   customers                         debts                               │
    │   ├── id (UUID)                     ├── id (UUID)                       │
    │   ├── company_id                    ├── company_id                      │
    │   ├── external_id (ERP)             ├── customer_id                     │
    │   ├── document                      ├── external_id (ERP)               │
    │   └── ...                           ├── amount                          │
    │                                     └── due_date                        │
    │                                                                         │
    │   erp_sync_logs                                                         │
    │   ├── company_id                                                        │
    │   ├── sync_type                                                         │
    │   ├── records_processed                                                 │
    │   ├── errors                                                            │
    │   └── created_at                                                        │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
\`\`\`

---

## Legend

\`\`\`
Symbol      Meaning
──────      ───────────────────────────────────
───►        Data/Control flow direction
│           Vertical connection
├──         Branch/Fork
└──         End of branch
┌──┐        Component/Module boundary
═══         Emphasis/Important boundary
...         Continuation/More items
\`\`\`

---

## Related Documentation

- [LEARNING_CONTEXT.md](./LEARNING_CONTEXT.md) - Comprehensive system documentation
- [QUICK_START.md](./QUICK_START.md) - Getting started guide
- [HOW_TO.md](./HOW_TO.md) - Common development tasks
- [CODE_EXAMPLES.md](./CODE_EXAMPLES.md) - Code snippets and examples
